<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Pulveriza√ß√£o - Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link rel="stylesheet" href="style.css" />
    <script src="auth.js"></script>

    <style>
        /* ... (Estilos CSS inalterados) ... */
        .titulo-principal {
            margin-top: 50px !important;
            margin-bottom: 3rem !important;
        }

        .main-content-padding {
            padding-top: 15px;
            padding-left: 0;
        }

        #verRelatoriosBtn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 9999;
        }

        .responsavel-card .form-control[readonly] {
            background-color: #e9ecef !important;
            font-weight: bold;
            color: #333;
        }

        body.dark-mode .responsavel-card .form-control[readonly] {
            background-color: #3a3a3a !important;
            color: #fff !important;
        }

        body.dark-mode {
            background-color: #1c1c1c !important;
            color: #e4e4e4;
        }

        body.dark-mode .card {
            background-color: #2a2a2a !important;
            color: #e4e4e4;
            border: 1px solid #444;
        }

        body.dark-mode select,
        body.dark-mode input,
        body.dark-mode .form-control {
            background-color: #3a3a3a !important;
            color: #fff !important;
            border-color: #555;
        }

        #toggleDarkMode {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            background: #f8f9fa;
            border: none;
            border-radius: 50%;
            padding: 10px 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            transition: 0.3s;
        }

        body.dark-mode #toggleDarkMode {
            background-color: #2c2c2c;
            color: #fff;
        }

        #logoutBtn {
            position: fixed;
            top: 15px;
            right: 70px;
            z-index: 9999;
        }

        #sidebar-relatorios-estatica {
            display: none;
        }

        /* Estilo da pr√©-visualiza√ß√£o da imagem */
        #previewImagem {
            display: none;
            max-width: 200px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
    </style>

    <script>
        if (typeof isUserLoggedIn !== 'function' || !isUserLoggedIn()) {
            window.location.href = "login.html";
        }
    </script>
</head>

<body class="bg-custom">
    <a href="relatorio-produtor.html" id="verRelatoriosBtn" class="btn btn-sm btn-info shadow"
        title="Visualizar Relat√≥rios">
        <i class="fas fa-chart-line me-1"></i> Relat√≥rios
    </a>

    <button id="toggleDarkMode" title="Alternar modo claro/escuro">üåô</button>
    <button id="logoutBtn" class="btn btn-sm btn-danger" title="Sair do Sistema">Sair</button>

    <div class="container-fluid main-content-padding">
        <main class="px-md-4 py-4">
            <h2 class="titulo-principal text-center">üöú Painel de C√°lculo de Pulveriza√ß√£o</h2>

            <div style="max-width: 900px; margin: auto;">

                <div class="card shadow p-4 mb-4 responsavel-card">
                    <label for="responsavelInput" class="form-label fw-semibold">üë®‚Äçüåæ Respons√°vel T√©cnico:</label>
                    <input type="text" id="responsavelInput" class="form-control" readonly />
                </div>

                <div class="card shadow p-4 mb-4">
                    <label for="produtorSelect" class="form-label fw-semibold">Selecione o Produtor:</label>
                    <select id="produtorSelect" class="form-select">
                        <option selected disabled>Selecione...</option>
                    </select>
                    <div id="produtorInfo" class="d-none mt-2 alert alert-info"></div>
                </div>

                <div id="painel-calculo-principal">

                    <div class="card shadow p-4 mb-4">
                        <label for="areaSelect" class="form-label fw-semibold">Selecione uma √Årea:</label>
                        <select id="areaSelect" class="form-select"></select>
                        <input type="hidden" id="areaSelecionadaNome" value="">
                        <div id="areaInfo" class="alert alert-secondary mt-3 d-none"></div>
                    </div>

                    <div class="card shadow p-4 mb-4">
                        <label for="pulverizadorSelect" class="form-label fw-semibold">Selecione um
                            Pulverizador:</label>
                        <select id="pulverizadorSelect" class="form-select"></select>
                        <div id="pulverizadorInfo" class="alert alert-secondary mt-3 d-none"></div>
                    </div>

                    <div id="bicoSection" class="card shadow p-4 mb-4 d-none">
                        <label for="bicoSelect" class="form-label fw-semibold">Selecione a Vaz√£o:</label>
                        <select id="bicoSelect" class="form-select"></select>
                        <div id="bicoInfo" class="alert alert-info mt-3 d-none"></div>
                    </div>

                    <div class="card shadow p-4 mb-4">
                        <label for="dataAplicacao" class="form-label fw-semibold">üìÖ Data prevista para
                            aplica√ß√£o:</label>
                        <input type="date" id="dataAplicacao" class="form-control w-auto" style="max-width: 220px;" />
                    </div>

                    <div class="card shadow p-4 mb-4">
                        <h5 class="fw-bold mb-3">üñºÔ∏è Imagem e Observa√ß√£o</h5>
                        <div class="row g-3 align-items-center">
                            <div class="col-md-5">
                                <label for="imagemCampo" class="form-label">Adicionar Imagem:</label>
                                <input type="file" id="imagemCampo" class="form-control" accept="image/*">
                                <img id="previewImagem" alt="Pr√©via da imagem">
                            </div>
                            <div class="col-md-7">
                                <label for="observacaoCampo" class="form-label">Observa√ß√£o:</label>
                                <textarea id="observacaoCampo" class="form-control" rows="4"
                                    placeholder="Digite aqui as observa√ß√µes sobre esta imagem..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div id="produtoSection" class="card shadow p-4 mb-4 d-none">
                        <h5 class="text-primary fw-bold mb-3">Produtos e Dosagens</h5>

                        <div class="row g-3 mb-3 align-items-end">
                            <div class="col-md-4">
                                <label for="categoriaSelect" class="form-label">Filtrar por Categoria:</label>
                                <select id="categoriaSelect" class="form-select">
                                    <option value="todas" selected>Todas</option>
                                    <option value="inseticida">Inseticidas</option>
                                    <option value="herbicida">Herbicidas</option>
                                    <option value="fungicida">Fungicidas</option>
                                    <option value="adjuvante">Adjuvantes</option>
                                </select>
                            </div>

                            <div class="col-md-8">
                                <label for="produtoSelect" class="form-label">Buscar e Selecionar Produto:</label>
                                <select id="produtoSelect" class="form-select" style="width: 100%;"></select>
                            </div>
                        </div>

                        <div id="produtosContainer"></div>
                        <div class="text-end"></div>
                    </div>

                    <div id="haPorTanqueInfo" class="alert alert-warning mt-3 d-none fw-semibold"></div>
                    <div id="tanquesInfo" class="alert alert-info mt-3 d-none fw-semibold"></div>
                    <div id="resultadoInfo" class="alert alert-success mt-4 d-none fw-semibold"></div>

                    <div id="campoSobressalente" class="alert alert-secondary mt-4 d-none fw-semibold">
                        <h5 class="mb-2 text-dark">üü© Bomba Picada:</h5>
                        <div id="sobressalenteConteudo"></div>
                    </div>

                    <div class="text-center mt-4">
                        <button id="salvarRelatorio" class="btn btn-primary px-4 py-2 me-2">
                            üíæ Salvar Relat√≥rio
                        </button>
                        <button id="exportarPDF" class="btn btn-outline-success px-4 py-2">
                            üìÑ Exportar Relat√≥rio em PDF
                        </button>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <footer style="text-align: center; padding: 10px; background-color: #f8f9fa; color: #555; font-size: 14px;">
        ¬© 2025 Tec Pulveriza√ß√£o Reis ‚Äî Desenvolvido por Jean Carlos. Todos os direitos reservados.
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="backend-simulado.js"></script>
    <script src="exportPDF.js"></script>
    <script src="script.js"></script>

    <script>
        // Fun√ß√£o auxiliar para converter arquivo de imagem para Base64 (Data URL)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(''); // Resolve com string vazia se n√£o houver arquivo
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const imagemInput = document.getElementById("imagemCampo");
            const preview = document.getElementById("previewImagem");
            const observacaoInput = document.getElementById("observacaoCampo"); // Adicionado

            imagemInput.addEventListener("change", () => {
                const file = imagemInput.files[0];
                if (file) {
                    preview.src = URL.createObjectURL(file);
                    preview.style.display = "block";
                } else {
                    preview.style.display = "none";
                }
            });

            const responsavelNome = localStorage.getItem('responsavelNome');
            const responsavelInput = document.getElementById('responsavelInput');

            if (responsavelInput) {
                responsavelInput.value = responsavelNome || "Usu√°rio n√£o identificado. Fa√ßa login novamente.";
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn && typeof logout === 'function') {
                logoutBtn.addEventListener('click', logout);
            }

            const btnSalvar = document.getElementById("salvarRelatorio");
            const LAST_SAVED_ID_KEY = "last_saved_report_id";
            if (btnSalvar) {
                btnSalvar.addEventListener("click", async () => {
                    // 1. Monta o relat√≥rio base
                    const relatorio = BackendSimulado.montarRelatorioAPartirDoDOM();
                    relatorio.responsavelTecnico = responsavelInput ? responsavelInput.value : "N√£o Informado";

                    if (!relatorio || relatorio.produtor === "Produtor n√£o informado") {
                        alert("‚ö†Ô∏è Preencha todos os campos antes de salvar o relat√≥rio.");
                        return;
                    }

                    // 2. **Captura e Converte a Imagem**
                    const file = imagemInput.files[0];
                    const base64Image = await fileToBase64(file);

                    // 3. **Adiciona os novos campos ao objeto relatorio**
                    relatorio.imagemBase64 = base64Image;
                    relatorio.observacao = observacaoInput.value.trim();

                    // 4. Salva o relat√≥rio
                    const idSalvo = BackendSimulado.adicionarRelatorio(relatorio);

                    if (idSalvo) localStorage.setItem(LAST_SAVED_ID_KEY, idSalvo);

                    alert("‚úÖ Relat√≥rio salvo com sucesso! ID: " + idSalvo);
                });
            }

            $('#produtoSelect').select2({
                placeholder: "Buscar produto...",
                allowClear: true,
                language: { noResults: () => "Nenhum produto encontrado" }
            });

            const toggleBtn = document.getElementById("toggleDarkMode");
            const currentMode = localStorage.getItem("modo");
            if (currentMode === "escuro") {
                document.body.classList.add("dark-mode");
                toggleBtn.textContent = "‚òÄÔ∏è";
            }
            toggleBtn.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");
                const isDark = document.body.classList.contains("dark-mode");
                toggleBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
                localStorage.setItem("modo", isDark ? "escuro" : "claro");
            });
        });
    </script>
</body>

</html>