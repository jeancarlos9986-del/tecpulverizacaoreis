<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Relat√≥rio | ID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="backend-simulado.js"></script>
    <script src="visualizar-relatorio.js" defer></script>

    <style>
        .detail-card {
            border-left: 5px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .status-badge {
            font-size: 1rem;
            padding: 0.5em 0.8em;
        }

        /* Estilos para o painel de atualiza√ß√£o */
        .update-panel {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #ced4da;
        }

        /* NOVO: Estilo para o painel de clima/aplica√ß√£o */
        .clima-card {
            border-left: 5px solid #28a745;
            /* Cor verde para destaque */
            background-color: #e6ffe6;
            /* Fundo mais claro */
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1 class="text-primary">Relat√≥rio de Aplica√ß√£o <span id="reportIdDisplay">#...</span></h1>
            <a href="relatorio-produtor.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar √†
                Lista</a>
        </header>

        <div class="card shadow p-4 mb-4 responsavel-card">
            <label for="responsavelInput" class="form-label fw-semibold">üë®‚Äçüåæ Respons√°vel T√©cnico:</label>
            <input type="text" id="responsavelInput" class="form-control" readonly />
        </div>

        <div id="loadingMessage" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Buscando dados do relat√≥rio...</p>
        </div>

        <div id="relatorioContent" class="d-none">

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100 detail-card">
                        <h5 class="card-title text-dark"><i class="fas fa-user-circle"></i> Produtor & √Årea</h5>
                        <p class="mb-1"><strong>Produtor:</strong> <span id="produtorNome"></span></p>
                        <p class="mb-1"><strong>√Årea:</strong> <span id="areaNome"></span> (<span
                                id="areaTamanho"></span> ha)</p>
                        <p class="mb-1"><strong>Data Prevista:</strong> <span id="dataPrevista"></span></p>
                        <p class="mb-1"><strong>Pulverizador:</strong> <span id="pulverizadorModelo"></span> (<span
                                id="pulverizadorCapacidade"></span> L)</p>
                        <p class="mb-0"><strong>Vaz√£o:</strong> <span id="vazaoLha"></span> L/ha</p>

                        <p class="mt-3 mb-0 text-success fw-bold"><i class="fas fa-check-circle"></i> Visita realizada
                            por: <span id="aplicadorResponsavel">Carregando...</span></p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 update-panel">
                        <h5 class="card-title text-dark"><i class="fas fa-edit"></i> Atualizar Status da Aplica√ß√£o</h5>
                        <form id="statusUpdateForm">
                            <div class="mb-3">
                                <label for="selectStatus" class="form-label">Status Atual:</label>
                                <select class="form-select" id="selectStatus" required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em andamento">Em andamento</option>
                                    <option value="Conclu√≠da">Conclu√≠da</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dataAplicacaoRealInput" class="form-label">Data da Aplica√ß√£o Real (Se
                                    conclu√≠da):</label>
                                <input type="date" class="form-control" id="dataAplicacaoRealInput">
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar
                                Atualiza√ß√£o</button>
                            <span id="updateMessage" class="ms-3 small text-success"></span>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card p-4 mb-4 clima-card">
                <h4 class="text-success"><i class="fas fa-cloud-sun"></i> Condi√ß√µes Clim√°ticas Registradas</h4>
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-1"><strong>üí® Vento:</strong> <span id="relatorioVento">--</span></p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>üå°Ô∏è Temperatura:</strong> <span id="relatorioTemperatura">--</span></p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>üíß Umidade:</strong> <span id="relatorioUmidade">--</span></p>
                    </div>
                    <div class="col-12 mt-2">
                        <p class="mb-0 small text-muted">Registro de Aplica√ß√£o: <span id="relatorioDataHora">--</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="card p-4 mb-4">
                <h4 class="text-secondary"><i class="fas fa-calculator"></i> C√°lculo de Dose & Tanques</h4>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Hectares por Tanque:</strong> <span id="haPorTanqueDisplay"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Tanques Necess√°rios:</strong> <span id="tanquesInfoDisplay"></span></p>
                    </div>
                </div>

                <h5 class="mt-3 text-dark">Resultados Detalhados por Produto:</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Dosagem (por ha)</th>
                                <th>Por Tanque</th>
                                <th>Total Necess√°rio</th>
                            </tr>
                        </thead>
                        <tbody id="produtosResultadoTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sobressalenteSection" class="card p-4 mb-4 d-none">
                <h4 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Sobressalente/Restante</h4>
                <div id="sobressalenteArea" class="mb-3"></div>
                <ul class="list-unstyled" id="sobressalenteProdutosList">
                </ul>
            </div>

            <div class="text-muted small mt-4 pt-3 border-top">
                <p class="mb-0">Gerado em: <span id="_geradoEm"></span></p>
                <p class="mb-0">√öltima atualiza√ß√£o: <span id="_atualizadoEm"></span></p>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger d-none mt-5">
            Relat√≥rio n√£o encontrado ou ID inv√°lido. Verifique o link.
        </div>
    </div>
    <footer style="text-align: center; padding: 10px; background-color: #f8f9fa; color: #555; font-size: 14px;">
        ¬© 2025 Tec Pulveriza√ß√£o Reis ‚Äî Desenvolvido por Jean Carlos. Todos os direitos reservados.
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Chaves do localStorage usadas nos scripts anteriores
        // (RESPONSAVEL_NOME_KEY √© global via auth.js)
        const REPORT_CLIMA_KEY = 'REPORT_CLIMA';
        const RESPONSAVEL_NOME_KEY = 'responsavelNome'; // Reafirmando a chave para o escopo

        document.addEventListener('DOMContentLoaded', () => {
            // ==========================================================
            // L√ìGICA 1: CARREGAR DADOS CLIM√ÅTICOS DO localStorage
            // ==========================================================
            const dadosClimaticosJSON = localStorage.getItem(REPORT_CLIMA_KEY);

            if (dadosClimaticosJSON) {
                try {
                    const dadosClimaticos = JSON.parse(dadosClimaticosJSON);

                    document.getElementById('relatorioVento').textContent = dadosClimaticos.velocidadeVento + ' km/h';
                    document.getElementById('relatorioTemperatura').textContent = dadosClimaticos.temperatura + ' ¬∞C';
                    document.getElementById('relatorioUmidade').textContent = dadosClimaticos.umidadeRelativa + ' %';
                    document.getElementById('relatorioDataHora').textContent = dadosClimaticos.dataHoraRegistro;

                } catch (e) {
                    console.error("Erro ao analisar dados clim√°ticos salvos:", e);
                    document.getElementById('relatorioVento').textContent = 'Dados corrompidos.';
                }
            } else {
                document.getElementById('relatorioVento').textContent = 'Nenhum dado clim√°tico registrado.';
            }

            // ==========================================================
            // L√ìGICA 2: CARREGAR NOME DO RESPONS√ÅVEL DO localStorage
            // ==========================================================
            const nomeDoResponsavel = localStorage.getItem(RESPONSAVEL_NOME_KEY);
            const responsavelElement = document.getElementById('aplicadorResponsavel');

            if (responsavelElement) {
                if (nomeDoResponsavel) {
                    responsavelElement.textContent = nomeDoResponsavel;
                } else {
                    // Texto se o nome n√£o for encontrado (usu√°rio n√£o logou corretamente)
                    responsavelElement.textContent = 'N√£o informado';
                    responsavelElement.parentElement.classList.remove('text-success');
                    responsavelElement.parentElement.classList.add('text-danger');
                }
            }
        });
    </script>
</body>

</html>